#!/usr/bin/bash

echo "$0: Testing Saleor Price Manager at $(date)"

# ==============================================================================
# âš™ï¸ S E T T I N G S
# ==============================================================================

set -eu || set -o errexit && set -o nounset; set -o pipefail; set +o history

cd "$(dirname "$0")"
DIVIDER="$(printf '=%.0s' {1..80})" && div() { echo "$DIVIDER"; }
error_code=1
ending="Testing completed."

abort() {
  ending="$1"
  exit ${2:-1}
}

cadence() {
  set +eu || set +o errexit && set +o nounset; set +o pipefail; set -o history
  [[ $error_code -ne 0 && "$ending" == "Testing completed." ]] && ending='Testing failed!'
  [[ -v ending && ! -z "$ending" ]] && echo "$0: $ending"
}; trap cadence EXIT

# Parse command line arguments
TEST_TYPE=${1:-all}  # all, api, frontend, quick

# ==============================================================================
# ðŸ“ Q U I C K  C H E C K S
# ==============================================================================

if [[ "$TEST_TYPE" == "quick" || "$TEST_TYPE" == "all" ]]; then
  echo 'ðŸš€ Running quick deployment checks...'
  div
  
  echo 'ðŸ“š Step 1: Checking executable permissions'
  if [[ -x ./DEPLOY && -x ./BANG && -x ./BUILD && -x ./START_FRONTEND ]]; then
    echo 'âœ… All scripts are executable'
  else 
    echo 'âŒ Some scripts are not executable'
    exit 1
  fi
  
  echo 'ðŸ“‹ Step 2: Checking for required files'
  REQUIRED_FILES=('main.py' 'requirements.txt' 'rust_modules/price_calculator/Cargo.toml' 'app/core/config.py' 'frontend/package.json')
  for file in "${REQUIRED_FILES[@]}"; do
    if [[ -f $file ]]; then
      echo "âœ… Found: $file"
    else
      echo "âŒ Missing: $file"
      exit 1
    fi
  done
  
  echo 'ðŸ Step 3: Checking Python version'
  if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version | cut -d" " -f2 | cut -d"." -f1,2)
    echo "âœ… Python version: $PYTHON_VERSION"
  else
    echo 'âŒ Python3 not found'
    exit 1
  fi
  
  echo 'ðŸ”§ Step 4: Checking Node.js version'
  if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    echo "âœ… Node.js version: $NODE_VERSION"
  else
    echo 'âš ï¸ Node.js not found (required for frontend)'
  fi
  
  echo 'âœ… Quick checks passed!'
  
  if [[ "$TEST_TYPE" == "quick" ]]; then
    error_code=0
    exit 0
  fi
fi

# ==============================================================================
# ðŸ§ª A P I  T E S T S  (Backend with pytest)
# ==============================================================================

if [[ "$TEST_TYPE" == "api" || "$TEST_TYPE" == "all" ]]; then
  echo 'ðŸ§ª Running API tests with pytest...'
  div
  
  # Check if virtual environment exists
  if [[ ! -d ./env ]]; then
    echo 'âš ï¸ Virtual environment not found. Running deployment first...'
    ./DEPLOY
  fi
  
  # Activate virtual environment
  source env/bin/activate
  
  # Install test dependencies
  echo 'Installing test dependencies...'
  pip install -r requirements-dev.txt
  
  # Run API tests
  echo 'Running pytest with coverage...'
  pytest tests/api/ --verbose --cov=app --cov-report=term-missing --cov-report=html:htmlcov
  
  API_TEST_EXIT_CODE=$?
  
  deactivate
  
  if [[ $API_TEST_EXIT_CODE -ne 0 ]]; then
    abort 'API tests failed!'
  fi
  
  echo 'âœ… API tests passed!'
fi

# ==============================================================================
# ðŸŒ F R O N T E N D  T E S T S  (Browser with Playwright)
# ==============================================================================

if [[ "$TEST_TYPE" == "frontend" || "$TEST_TYPE" == "all" ]]; then
  echo 'ðŸŒ Running frontend E2E tests with Playwright...'
  div
  
  cd frontend
  
  # Install dependencies if needed
  if [[ ! -d node_modules ]]; then
    echo 'Installing frontend dependencies...'
    if command -v pnpm &> /dev/null; then
      pnpm install
    else
      npm install
    fi
  fi
  
  # Install Playwright browsers
  if [[ ! -d node_modules/@playwright/test ]]; then
    echo 'Installing Playwright...'
    if command -v pnpm &> /dev/null; then
      pnpm add -D @playwright/test
    else
      npm install --save-dev @playwright/test
    fi
  fi
  
  # Install Playwright browsers
  echo 'Installing Playwright browsers...'
  npx playwright install
  
  # Run frontend tests
  echo 'Running Playwright E2E tests...'
  npx playwright test --reporter=line
  
  FRONTEND_TEST_EXIT_CODE=$?
  
  cd ..
  
  if [[ $FRONTEND_TEST_EXIT_CODE -ne 0 ]]; then
    abort 'Frontend tests failed!'
  fi
  
  echo 'âœ… Frontend tests passed!'
fi

# ==============================================================================
# ðŸ“‹ T E S T  S U M M A R Y
# ==============================================================================

echo 'Test Summary:'
div

if [[ "$TEST_TYPE" == "all" ]]; then
  echo 'âœ… Quick deployment checks: PASSED'
  echo 'âœ… API tests (pytest with mocks): PASSED'
  echo 'âœ… Frontend tests (Playwright E2E): PASSED'
  echo ''
  echo 'ðŸ“ˆ Coverage reports:'
  echo '   API Coverage: htmlcov/index.html'
  echo '   Frontend Report: frontend/playwright-report/index.html'
elif [[ "$TEST_TYPE" == "api" ]]; then
  echo 'âœ… API tests (pytest with mocks): PASSED'
  echo 'ðŸ“ˆ API Coverage: htmlcov/index.html'
elif [[ "$TEST_TYPE" == "frontend" ]]; then
  echo 'âœ… Frontend tests (Playwright E2E): PASSED'
  echo 'ðŸ“ˆ Frontend Report: frontend/playwright-report/index.html'
elif [[ "$TEST_TYPE" == "quick" ]]; then
  echo 'âœ… Quick deployment checks: PASSED'
fi

echo ''
echo 'ðŸŽ† All tests completed successfully!'
echo ''
echo 'ðŸš€ Usage:'
echo '   ./TEST           # Run all tests (quick + api + frontend)'
echo '   ./TEST quick     # Run only quick deployment checks'
echo '   ./TEST api       # Run only API tests with pytest'
echo '   ./TEST frontend  # Run only frontend E2E tests with Playwright'

error_code=0
exit $error_code