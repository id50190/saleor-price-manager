#!/usr/bin/bash

echo "$0: Running Docker-based tests at $(date)"

set -eu
cd "$(dirname "$0")"

# Auto-detect Docker Compose command
if command -v docker-compose >/dev/null 2>&1; then
  DOCKER_COMPOSE="docker-compose"
  COMPOSE_VERSION=$(docker-compose --version 2>/dev/null || echo "unknown")
  echo "ğŸ³ Using docker-compose (v1): $COMPOSE_VERSION"
elif docker compose version >/dev/null 2>&1; then
  DOCKER_COMPOSE="docker compose"
  COMPOSE_VERSION=$(docker compose version --short 2>/dev/null || echo "v2")
  echo "ğŸ³ Using docker compose (v2): $COMPOSE_VERSION"
else
  echo "âŒ Error: Neither 'docker-compose' nor 'docker compose' is available!"
  echo "Please install Docker Compose: https://docs.docker.com/compose/install/"
  exit 1
fi

# Validate Docker Compose configuration
echo "ğŸ”§ Validating Docker Compose configuration..."
if ! $DOCKER_COMPOSE -f docker-compose.test.yml config --quiet 2>/dev/null; then
  echo "âŒ Error: Invalid docker-compose.test.yml configuration!"
  echo "Run: $DOCKER_COMPOSE -f docker-compose.test.yml config"
  exit 1
fi

TEST_TYPE=${1:-all}

case $TEST_TYPE in
  "api")
    echo "ğŸ§ª Running API tests in Docker..."
    $DOCKER_COMPOSE -f docker-compose.test.yml up --build redis-test api-test
    $DOCKER_COMPOSE -f docker-compose.test.yml run --rm test-runner pytest tests/api/ --verbose
    ;;
  "frontend")
    echo "ğŸŒ Running frontend E2E tests in Docker..."
    $DOCKER_COMPOSE -f docker-compose.test.yml --profile e2e up --build
    ;;
  "integration")
    echo "ğŸ”„ Running integration tests in Docker..."
    $DOCKER_COMPOSE -f docker-compose.test.yml up --build
    $DOCKER_COMPOSE -f docker-compose.test.yml run --rm test-runner pytest tests/api/test_integration.py -m integration
    ;;
  "all")
    echo "ğŸš€ Running all tests in Docker..."
    # Start services
    $DOCKER_COMPOSE -f docker-compose.test.yml up -d --build redis-test api-test frontend-test
    
    # Wait for services to be healthy
    echo "â³ Waiting for services to be ready..."
    sleep 10
    
    # Run API tests
    echo "ğŸ§ª Running API tests..."
    $DOCKER_COMPOSE -f docker-compose.test.yml run --rm test-runner pytest tests/api/ --verbose --cov=app
    API_EXIT_CODE=$?
    
    # Run E2E tests
    echo "ğŸŒ Running E2E tests..."
    $DOCKER_COMPOSE -f docker-compose.test.yml --profile e2e run --rm playwright-runner
    E2E_EXIT_CODE=$?
    
    # Cleanup
    $DOCKER_COMPOSE -f docker-compose.test.yml down
    
    # Check results
    if [[ $API_EXIT_CODE -ne 0 || $E2E_EXIT_CODE -ne 0 ]]; then
      echo "âŒ Some tests failed!"
      exit 1
    fi
    
    echo "âœ… All Docker tests passed!"
    ;;
  *)
    echo "Usage: $0 [api|frontend|integration|all]"
    echo "  api         - Run API tests with pytest"
    echo "  frontend    - Run frontend E2E tests with Playwright"
    echo "  integration - Run integration tests"
    echo "  all         - Run all tests (default)"
    exit 1
    ;;
esac

echo "ğŸ‰ Docker tests completed successfully!"
exit 0